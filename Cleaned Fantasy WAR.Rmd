---
title: "R Notebook"
output: html_notebook
---
Data Setup:
```{r}
library(readr)
library(tidyverse)
library(psych)
qb_18 <- read_csv("D:/Fantasy Week By Week/QB.csv") %>%
  filter(Year == 2018)
qb_18 <- mutate(qb_18, Stand_Points = (Yards * .04) + (TD *4) + (Two_Pass * 2) + (Rush_Yards * .1) + (Rush_TD * 6) + (Two_Rush * 2) + (Rec_Yards * .1) + 
                  (Rec_TD * 6) + (Two_Rec * 2))


RB <- read_csv("D:/Fantasy Week By Week/RB.csv")
rb_18 <- mutate(RB, Stand_Points = (Yards * .04) + (TD *4) + (Two_Pass * 2) + (Rush_Yards * .1) + (Rush_TD * 6) + (Two_Rush * 2) + (Rec_Yards * .1) + 
                  (Rec_TD * 6) + (Two_Rec * 2))

WR <- read_csv("D:/Fantasy Week By Week/WR.csv")
wr_18 <- mutate(WR, Stand_Points = (Yards * .04) + (TD *4) + (Two_Pass * 2) + (Rush_Yards * .1) + (Rush_TD * 6) + (Two_Rush * 2) + (Rec_Yards * .1) + 
                  (Rec_TD * 6) + (Two_Rec * 2))

TE <- read_csv("D:/Fantasy Week By Week/TE.csv")

TE <- mutate(TE, Stand_Points = (Yards * .04) + (TD *4) + (Two_Pass * 2) + (Rush_Yards * .1) + (Rush_TD * 6) + (Two_Rush * 2) + (Rec_Yards * .1) + (Rec_TD * 6) + (Two_Rec * 2))

K <- read_csv("D:/Fantasy Week By Week/K.csv")
DST <- read_csv("D:/Fantasy Week By Week/DST.csv")

```


Figure out what the average team scores per week 

```{r}
#QB
qb_top_12 <- qb_18 %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(n = 12, wt = total_pts)

qb_top_12 <- qb_top_12$Player

qb_std <- qb_18 %>%
  filter(Player %in% qb_top_12) 

describe(qb_std)

hist(qb_std$Stand_Points)

#RB1
rb_top_12 <- rb_18 %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(n = 12, wt = total_pts)

rb_top_12 <- rb_top_12$Player

total_rb_std <- rb_18 %>%
  filter(Player %in% rb_top_12)
describe(total_rb_std$Stand_Points)

hist(total_rb_std$Stand_Points)

#RB2
rb_top_13_24 <- rb_18 %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(24, wt = total_pts) %>%
  top_n(-12, wt = total_pts)

rb_top_13_24 <- rb_top_13_24$Player

total_rb2_std <- rb_18 %>%
  filter(Player %in% rb_top_13_24)
describe(total_rb2_std$Stand_Points)

hist(total_rb2_std$Stand_Points)

#WR1

wr_top_12 <- wr_18 %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(12, wt = total_pts) 

wr_top_12_players <- wr_top_12$Player

total_wr_12 <- wr_18 %>%
  filter(Player %in% wr_top_12_players)

describe(total_wr_12$Stand_Points)

hist(total_wr_12$Stand_Points)

#WR2

wr_top_13_24 <- wr_18 %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(24, wt = total_pts) %>%
  top_n(-12, wt = total_pts)

wr_top_13_24_players <- wr_top_13_24$Player

total_wr_13_24 <- wr_18 %>%
  filter(Player %in% wr_top_13_24_players)

describe(total_wr_13_24$Stand_Points)

hist(total_wr_13_24$Stand_Points)

#FLEX

#RB qualifying flex pool
rb_flex <- rb_18 %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(36, wt = total_pts) %>%
  top_n(-12, wt = total_pts)

rb_flex_players <- rb_flex$Player

rb_flex <- rb_18 %>%
  filter(Player %in% rb_flex_players)

#WR qualifying flex pool
wr_flex <- wr_18 %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(36, wt = total_pts) %>%
  top_n(-12, wt = total_pts)
wr_flex_players <- wr_flex$Player

wr_flex <- wr_18 %>%
  filter(Player %in% wr_flex_players)

#TE qualifying flex pool
te_flex <- TE %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(24, wt = total_pts) %>%
  top_n(-12, wt = total_pts)
te_flex_players <- te_flex$Player

#calculate average of the best 12 flex qualifiers
flex <- bind_rows(rb_flex,wr_flex,te_flex)

flex <- mutate(flex, Stand_Points = (Yards * .04) + (TD *4) + (Two_Pass * 2) + (Rush_Yards * .1) + (Rush_TD * 6) + (Two_Rush * 2) + (Rec_Yards * .1) + (Rec_TD * 6) + (Two_Rec * 2))

flex_players <- flex %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(12, wt = total_pts)

flex_players <- flex_players$Player

flex <- flex %>%
  filter(Player %in% flex_players)

describe(flex$Stand_Points)

hist(flex$Stand_Points)

#TE1

te_12 <- TE %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Stand_Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(12, wt = total_pts) 

te_players <- te_12$Player

te_12 <- TE %>%
  filter(Player %in% te_players)

describe(te_12$Stand_Points)

hist(te_12$Stand_Points)

#K

kicker_12 <- K %>%
  group_by(Player) %>%
  summarise(total_pts = sum(Points)) %>%
  arrange(desc(total_pts)) %>%
  top_n(12, wt = total_pts)

k_players <- kicker_12$Player

kicker_12 <- K %>%
  filter(Player %in% k_players)

describe(kicker_12$Points)

#DST

dst_12 <- DST %>%
  group_by(Team) %>%
  summarise(total_pts = sum(`Pts*`)) %>%
  arrange(desc(total_pts)) %>%
  top_n(12, wt = total_pts)

dst_names <- dst_12$Team

dst_12 <- DST %>%
  filter(Team %in% dst_names)

describe(dst_12$`Pts*`)
```

Each describe call gives the mean and std for each position which are:
QB: 21.75, 7.98
RB1: 16.41, 8.7
RB2: 11.12, 7.3
WR1: 12.74, 6.52
WR2: 10.14, 6.86
TE: 8.09, 6.29
FlX: 8.65, 6.01
K:   8.89, 4.12
DST: 10.57, 6.77

```{r}
#fantasy team average weekly score
21.75 + 16.41 + 11.12 + 12.74 + 10.14 + 8.09 + 8.65 + 8.89 + 10.57

#fantasy team average weekly score standard deviation
sqrt(7.98^2 + 8.7^2 + 7.3^2 + 6.52^2 + 6.86^2 + 6.29^2 + 6.01^2 + 4.12^2 + 6.77^2)
```

2018's average team total standard deviation = 108.36
2018's average team total standard deviation = 20.51

Now to compute a fantasy teams expected weekly score based on individual player performance
```{r}
qb_18 <- mutate(qb_18, exp_team_score = (Stand_Points - 21.75) + 108.36)
```

Use pnorm to calculate odds of a fantasy team win based on individual player performance

```{r}
for (i in 1:nrow(qb_18)) {
  qb_18$win_prob[i] <- pnorm(qb_18$exp_team_score[i], 108.36, 20.51) 
}
```

Create table with war results and wins above average (WAA) results.
```{r}
war <- qb_18 %>%
  group_by(Player) %>%
  summarize(Avr_Win_Percent = mean(win_prob), Games = n(), Wins_exp = Avr_Win_Percent*13, WAA = Wins_exp -6.5, repl_per = .4690, repl_wins = .4690*13, WAR = Wins_exp - repl_wins, Ave_Week_Points = mean(Stand_Points)) %>%
  filter(Games >7) %>%
  arrange(desc(WAR)) %>%
  select(Player, Ave_Week_Points, Avr_Win_Percent, WAR, WAA)

write.csv(war, file = "qb_war_cleaned.csv")
```

